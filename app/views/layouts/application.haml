!!!
%html
  %head
    %title= (Rails.env.development? ? t('.title.prefix') : '') + (@page_title ? @page_title + t('.title.postfix') : t('.title.fallback'))

    / Meta
    %meta{charset: 'utf-8'}
    %meta{name: 'viewport', content: 'width=device-width'}
    = csrf_meta_tags

    / SEO canonical
    - if @meta_canonical.present?
      %link{rel: 'canonical', href: @meta_canonical}

    / OpenGraph embed data
    - if @meta_og.present?
      :ruby
        image_hash = @meta_og.fetch(:image, {
          src: asset_url('favicons/og-image-48x48.png'),
          type: 'image/png',
          alt: t('.alt.favicon'),
          width: '48',
          height: '48',
        })
      %meta{property: 'og:image', content: image_hash[:src]}
      - [:type, :alt, :width, :height].each do |prop|
        - if image_hash.key?(prop)
          %meta{property: "og:image:#{prop}", content: image_hash[prop]}

      %meta{property: 'og:type', content: 'website'}
      %meta{property: 'og:site_name', content: 'Glowfic Constellation'}

      %meta{property: 'og:url', content: @meta_og[:url]}
      %meta{property: 'og:title', content: @meta_og[:title]}
      %meta{property: 'og:description', content: @meta_og[:description]}

    / Stylesheets
    = stylesheet_link_tag 'application'
    - if current_user.try(:layout).present?
      = stylesheet_link_tag "layouts/#{current_user.layout}"

    / Favicons
    %meta{name: "apple-mobile-web-app-title", content: "Glowfic Constellation"}
    %meta{name: "application-name", content: "Glowfic Constellation"}
    %meta{name: "msapplication-config", content: asset_path('favicons/browserconfig.xml')}
    %meta{name: "theme-color", content: "#FFFFFF"}
    = favicon_link_tag 'favicons/favicon.ico'
    = favicon_link_tag 'favicons/favicon-32x32.png', type: 'image/png', rel: 'icon', sizes: '32x32'
    = favicon_link_tag 'favicons/favicon-16x16.png', type: 'image/png', rel: 'icon', sizes: '16x16'
    = favicon_link_tag 'favicons/apple-touch-icon.png', type: 'image/png', rel: 'apple-touch-icon', sizes: '180x180'
    %link{rel: 'mask-icon', href: asset_path('favicons/safari-pinned-tab.svg'), color: '#2B5797'}
    %link{rel: 'manifest', href: asset_path('favicons/manifest.json')}

    = include_gon
    = javascript_include_tag 'application_deferred'.freeze, defer: :defer
  %body
    #holder
      #header
        - if logged_in?
          #user-info
            = link_to current_user do
              - if current_user.avatar
                = image_tag current_user.avatar.url, class: 'icon', id: 'user-icon', title: current_user.avatar.keyword, alt: current_user.avatar.keyword
              - else
                .no-img
              #user-username= current_user.username
        #header-right
          #logo
            - unless logged_in?
              #header-links
                = link_to t('.button.login'), login_path
                %span &nbsp;|&nbsp;
                = link_to t('.button.signup'), new_user_path
            = link_to root_path do
              = image_tag "layouts/logo.png", alt: t('.alt.logo')
          #nav-top
            - if logged_in?
              %ul
                %li= link_to 'Account', edit_user_path(current_user)
                - unless current_user.read_only?
                  %li
                    = link_to messages_path do
                      Inbox
                      - unread_count = Message.unread_count_for(current_user)
                      - if unread_count > 0
                        %span.badge.badge-primary= unread_count
                  %li= link_to Character.model_name.human(count: 2), user_characters_path(current_user)
                  %li= link_to Gallery.model_name.human(count: 2), user_galleries_path(current_user)
                %li= link_to Favorite.model_name.human(count: 2), favorites_path
                - unless current_user.read_only?
                  %li= link_to t('.button.post'), new_post_path
              = link_to logout_path, method: :delete, id: :"header-logout", data: { confirm: t('.logout.confirm') } do
                = button_tag t('.button.logout'), class: 'button'
            - elsif !current_page?(login_path)
              = form_tag login_path, method: :post, id: 'header-form' do
                #header-forms
                  = text_field_tag :username, params[:username], placeholder: t('.placeholder.username')
                  = password_field_tag :password, params[:password], placeholder: t('.placeholder.password')
                #header-remember
                  = check_box_tag :remember_me
                  = label_tag :remember_me, t('.label.remember_me')
                #header-buttons
                  = submit_tag t('.submit.login'), class: 'button'
                #header-buttons-links
                  = link_to t('.button.signup'), new_user_path
                  &nbsp;|&nbsp;
                  = link_to t('.button.forgot'), new_password_reset_path
        #nav-bottom
          %ul
            %li= link_to Board.model_name.human(count: 2), continuities_path
            %li= link_to t('posts.index.title.updated'), posts_path
            %li= link_to t('generic.search.title'), search_posts_path
            %li= link_to User.model_name.human(count: 2), users_path
            %li= link_to t('characters.facecasts.title'), facecasts_characters_path
            - if logged_in?
              %li= link_to t('posts.unread.button'), unread_posts_path
              - unless current_user.read_only?
                %li= link_to t('posts.owed.button'), owed_posts_path
            %li= link_to Tag.model_name.human(count: 2), tags_path
            - day = DailyReport.unread_date_for(current_user)
            - daybadge = DailyReport.badge_for(day)
            %li
              = link_to t('reports.daily.title'), report_path(id: :daily, day: day&.to_s)
              - if daybadge > 0
                %span.badge.badge-primary= daybadge
      - if content_for?(:breadcrumbs)
        .flash.breadcrumbs= content_for :breadcrumbs
      - flash.each do |key, val|
        .flash{class: key}
          = link_to '#' do
            = image_tag 'icons/cross.png', class: 'float-right flash-dismiss', alt: t('alt.dismiss')
          - if val.is_a?(Hash)
            - if val.key?(:image)
              = image_tag val[:image], class: 'vmid'.freeze
            = val[:message]
            - if val.key?(:array)
              %ul
                - val[:array].each do |message|
                  %li= message
          - else
            = val
      - if content_for?(:flashes)
        = content_for :flashes
      - unless logged_in? || tos_skippable?
        #tos.hidden= render 'about/accept_tos'
      #content
        = yield
        .clear &nbsp;
      #footer
        %div
          = link_to t('about.tos.title'), tos_path
          &bull;
          = link_to t('about.privacy.title'), privacy_path
          &bull;
          = link_to t('about.dmca.button'), dmca_path
          &bull;
          = link_to t('about.contact.title'), contact_path
          &bull;
          = link_to t('about.contribute.title'), contribute_path
          &bull;
          - news_count = News.num_unread_for(current_user)
          = link_to news_index_path(page: (news_count > 1 ? news_count : nil)) do
            = t('news.index.button')
            - if news_count > 0
              %span.badge.badge-primary= news_count

    = javascript_include_tag 'application'.freeze
    - (@javascripts || []).each do |javascript|
      = javascript_include_tag javascript
